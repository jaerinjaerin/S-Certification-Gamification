// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
  output        = env("PRISMA_CLIENT_OUTPUT")
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  type              String
  provider          String
  providerAccountId String   @map("provider_account_id")
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.Text
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  expires      DateTime
  sessionToken String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id])

  @@map("sessions")
}

model User {
  id            String    @id @default(uuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  accounts      Account[]
  sessions      Session[]

  emailId String?

  authType AuthType

  providerUserId   String?
  providerPersonId String?
  jobId            String?
  // job               Job? @relation(fields: [jobId], references: [id])

  domainId   String?
  domainCode String?
  languageId String?

  regionId         String?
  subsidiaryId     String?
  storeId          String?
  storeSegmentText String?
  channelId        String?
  channelSegmentId String?

  channelName String? // S+미사용 유저가 채널을 직접 입력한 경우, 여기에 저장
  UserRole    UserRole[]

  @@map("users")
}

model VerificationRequest {
  id         String   @id @default(uuid())
  identifier String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, token])
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model VerifyToken {
  id        String   @id @default(uuid()) // 고유 식별자
  email     String // 인증할 이메일
  token     String // 인증 토큰 (6개의 숫자 문자열)
  expiresAt DateTime // 토큰 만료 시간
  createdAt DateTime @default(now()) // 생성 시간
  updatedAt DateTime @updatedAt // 마지막 갱신 시간

  @@index([email]) // 이메일 검색을 빠르게 하기 위한 인덱스
  @@index([token]) // 토큰 검색을 빠르게 하기 위한 인덱스
}

enum AuthType {
  SUMTOTAL
  GUEST
  UNKNOWN
}

model Language {
  id   String @id @default(uuid())
  code String @unique // Language code (e.g., en, fr, es)
  name String // Language name
}

model Campaign {
  id          String   @id @default(uuid())
  name        String // Name of the campaign
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  startedAt DateTime
  endedAt   DateTime

  createrId String
  updaterId String?

  quizSets QuizSet[]

  domainId String?
}

model Hq {
  id    String @id
  name  String
  code  String @unique // Domain name
  order Int?

  regions Region[]
}

model Region {
  id    String @id
  name  String
  code  String @unique // Domain name
  order Int?

  hqId String?
  hq   Hq?     @relation(fields: [hqId], references: [id])

  subsidiaries Subsidiary[]
}

model Subsidiary {
  id    String @id
  name  String
  code  String @unique // Domain name
  order Int?

  regionId String?
  region   Region? @relation(fields: [regionId], references: [id])

  domains Domain[]
}

model Domain {
  id           String  @id
  name         String
  code         String  @unique // Domain name
  subsidiaryId String?
  order        Int?

  subsidiary Subsidiary? @relation(fields: [subsidiaryId], references: [id])

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  Permission   Permission? @relation(fields: [permissionId], references: [id])
  permissionId String?
}

model DomainGoal {
  id         String   @id @default(uuid())
  campaignId String
  ff         Int
  fsm        Int
  ffSes      Int
  fsmSes     Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  domainId     String
  regionId     String?
  subsidiaryId String?
}

model QuizSet {
  id String @id @default(uuid())

  campaignId   String // Foreign key to Campaign
  domainId     String? // Foreign key to Domain
  languageId   String? // Foreign key to Language
  subsidiaryId String? // Foreign key to Subsidiary
  jobCodes     String[]
  quizStages   QuizStage[]

  createrId String
  updaterId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id])
}

model QuizBadge {
  id          String   @id @default(uuid())
  name        String?
  description String?
  imagePath   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  quizStages QuizStage[]
  // activities Activity[]

  campaignId String?
  domainId   String?
}

model Image {
  id            String   @id @default(uuid())
  alt           String?
  title         String?
  caption       String?
  format        String
  categories    String[]
  imagePath     String
  thumbnailPath String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  questionsBackgrounds Question[] @relation("BackgroundImage")
  questionsCharacters  Question[] @relation("CharacterImage")

  campaignId String?
  domainId   String?
}

model QuizStage {
  id    String @id @default(uuid())
  name  String // Name of the stage]
  order Int // Order of the stage within the quiz set

  questionIds String[]
  lifeCount   Int // Number of lives for the question
  quizSetId   String
  quizSet     QuizSet  @relation(fields: [quizSetId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  isBadgeStage    Boolean?
  badgeActivityId String?

  badgeImageId String?
  badgeImage   QuizBadge? @relation(fields: [badgeImageId], references: [id])

  campaignId String?
  domainId   String?
  languageId String?
}

model Question {
  id   String @id @default(uuid())
  text String // Text of the question in default language

  timeLimitSeconds Int // Expiration time for the question in seconds
  options          QuestionOption[] // Associated options
  order            Int

  languageId         String // Foreign key to Language
  originalQuestionId String // Foreign key to Question
  originalIndex      Int // Foreign key to Question

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  backgroundImageId String?
  characterImageId  String?

  backgroundImage Image? @relation("BackgroundImage", fields: [backgroundImageId], references: [id])
  characterImage  Image? @relation("CharacterImage", fields: [characterImageId], references: [id])

  category        String?
  specificFeature String?
  importance      String?
  product         String?
  enabled         Boolean
  questionType    QuestionType

  campaignId String?
  domainId   String? // 필수로 넣어야 함
}

enum QuestionType {
  MULTI_CHOICE
  SINGLE_CHOICE
  TRUE_FALSE
}

model QuestionOption {
  id         String   @id @default(uuid())
  text       String // Text of the option
  order      Int // Order of the option within the question
  questionId String // Foreign key to Question
  question   Question @relation(fields: [questionId], references: [id])
  languageId String
  isCorrect  Boolean // Whether the option is correct

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  domainId String?
}

model Job {
  id          String   @id
  code        String
  group       String
  name        String // Name of the user group (e.g., A, B)
  description String? // Optional description
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Store {
  id        String   @id
  name      String
  // code       String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Channel {
  id   String @id @default(uuid())
  name String // e.g., "Carrier", "Retailer (MM/IT/Traditional etc)"
}

model ChannelSegment {
  id   String @id @default(uuid())
  name String // e.g., "Carrier", "Retailer (MM/IT/Traditional etc)"
}

model UserQuizLog {
  id                 String   @id @default(uuid())
  userId             String
  authType           AuthType
  campaignId         String
  isCompleted        Boolean?
  isBadgeAcquired    Boolean?
  lastCompletedStage Int?
  elapsedSeconds     Int? // Time spent on this activity (in seconds)
  createdAt          DateTime @default(now()) // 히스토리 생성 시간
  updatedAt          DateTime @updatedAt // 히스토리 수정 시간

  quizSetId String

  score Int?

  quizSetPath String?

  domainId   String?
  languageId String?

  jobId String?

  regionId         String?
  subsidiaryId     String?
  storeId          String?
  storeSegmentText String?
  channelId        String?
  channelSegmentId String?
  channelName      String?

  @@unique([userId, campaignId])
}

model UserQuizBadgeStageLog {
  id         String   @id @default(uuid())
  userId     String
  authType   AuthType
  campaignId String

  isBadgeAcquired Boolean?
  badgeActivityId String?
  elapsedSeconds  Int?
  createdAt       DateTime @default(now()) // 히스토리 생성 시간
  updatedAt       DateTime @updatedAt // 히스토리 수정 시간

  quizSetId      String
  quizStageId    String
  quizStageIndex Int

  score Int

  domainId         String?
  languageId       String?
  jobId            String?
  regionId         String?
  subsidiaryId     String?
  storeId          String?
  storeSegmentText String?
  channelId        String?
  channelSegmentId String?
  channelName      String?

  // quizBadgeType QuizBadgeType?

  @@unique([userId, campaignId, quizStageId])
}

model UserQuizStageLog {
  id       String   @id @default(uuid())
  userId   String // Foreign key to User
  authType AuthType

  campaignId      String
  quizStageId     String // Foreign key to Stage
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  isBadgeStage    Boolean?
  isBadgeAcquired Boolean?
  badgeActivityId String?

  // completerType          QuizCompleterType?

  remainingHearts Int

  quizSetId      String
  quizStageIndex Int

  elapsedSeconds Int

  score      Int?
  totalScore Int?
  percentile Int?
  scoreRange String?

  domainId   String
  languageId String?
  jobId      String

  regionId         String?
  subsidiaryId     String?
  storeId          String?
  storeSegmentText String?
  channelId        String?
  channelSegmentId String?
  channelName      String?
}

model UserQuizQuestionLog {
  id        String   @id @default(uuid())
  userId    String // Foreign key to User
  authType  AuthType
  quizSetId String // Foreign key to QuizSet

  // user result
  questionId   String // Foreign key to Question
  questionText String?

  isCorrect         Boolean // Whether the user answered the question correctly
  selectedOptionIds String[]
  correctOptionIds  String[]
  quizStageId       String

  quizStageIndex Int
  elapsedSeconds Int

  // question
  questionType    QuestionType
  category        String?
  product         String?
  specificFeature String?
  importance      String?

  // country
  campaignId String
  jobId      String
  languageId String?

  domainId String?

  regionId         String?
  subsidiaryId     String?
  storeId          String?
  storeSegmentText String?
  channelId        String?
  channelSegmentId String?
  channelName      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tryNumber Int

  originalQuestionId String?
  originalIndex      Int?
}

model UserQuizStatistics {
  id                 String   @id @default(uuid())
  userId             String
  authType           AuthType
  campaignId         String
  isCompleted        Boolean?
  isBadgeAcquired    Boolean?
  lastCompletedStage Int?
  elapsedSeconds     Int? // Time spent on this activity (in seconds)
  createdAt          DateTime @default(now()) // 히스토리 생성 시간
  updatedAt          DateTime @updatedAt // 히스토리 수정 시간

  quizSetId String

  score Int?

  quizSetPath String?

  domainId   String?
  languageId String?

  jobId String?

  regionId         String?
  subsidiaryId     String?
  storeId          String?
  storeSegmentText String?
  channelId        String?
  channelSegmentId String?
  channelName      String?
}

model UserQuizBadgeStageStatistics {
  id         String   @id @default(uuid())
  userId     String
  authType   AuthType
  campaignId String

  isBadgeAcquired Boolean?
  badgeActivityId String?
  elapsedSeconds  Int?
  createdAt       DateTime @default(now()) // 히스토리 생성 시간
  updatedAt       DateTime @updatedAt // 히스토리 수정 시간

  quizSetId      String
  quizStageId    String
  quizStageIndex Int

  score Int

  domainId         String?
  languageId       String?
  jobId            String?
  regionId         String?
  subsidiaryId     String?
  storeId          String?
  storeSegmentText String?
  channelId        String?
  channelSegmentId String?
  channelName      String?

  // quizBadgeType QuizBadgeType?

  @@unique([userId, campaignId, quizStageId])
}

model UserQuizStageStatistics {
  id       String   @id @default(uuid())
  userId   String // Foreign key to User
  authType AuthType

  campaignId      String
  quizStageId     String // Foreign key to Stage
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  isBadgeStage    Boolean?
  isBadgeAcquired Boolean?
  badgeActivityId String?

  remainingHearts Int

  quizSetId      String
  quizStageIndex Int

  elapsedSeconds Int

  score      Int?
  totalScore Int?
  percentile Int?
  scoreRange String?

  domainId   String
  languageId String?
  jobId      String

  regionId         String?
  subsidiaryId     String?
  storeId          String?
  storeSegmentText String?
  channelId        String?
  channelSegmentId String?
  channelName      String?
}

model UserQuizQuestionStatistics {
  id        String   @id @default(uuid())
  userId    String // Foreign key to User
  authType  AuthType
  quizSetId String // Foreign key to QuizSet

  // user result
  questionId   String // Foreign key to Question
  questionText String?

  isCorrect         Boolean // Whether the user answered the question correctly
  selectedOptionIds String[]
  correctOptionIds  String[]
  quizStageId       String

  quizStageIndex Int
  elapsedSeconds Int

  tryNumber Int

  // question
  questionType    QuestionType
  category        String?
  product         String?
  specificFeature String?
  importance      String?

  // country
  campaignId String
  jobId      String
  languageId String?

  domainId String?

  regionId         String?
  subsidiaryId     String?
  storeId          String?
  storeSegmentText String?
  channelId        String?
  channelSegmentId String?
  channelName      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  originalQuestionId String?
  originalIndex      Int?
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       UserRole[]
  permissions RolePermission[]
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roles   RolePermission[]
  domains Domain[]
}

model RolePermission {
  id           String   @id @default(uuid())
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  @@unique([roleId, permissionId], name: "role_permission_unique")
  @@index([roleId])
  @@index([permissionId])
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  role Role @relation(fields: [roleId], references: [id])

  @@unique([userId, roleId], name: "user_role_unique")
  @@index([userId])
  @@index([roleId])
}

// model Activity {
//   id              String   @id @default(uuid())
//   campaignId      String
//   activityId      String
//   jobCodes        String[]

//   domainId        String
//   languageId      String

//   badgeImageId    String?
//   badgeImage      QuizBadge? @relation(fields: [badgeImageId], references: [id]) 

//   createdAt       DateTime @default(now())
//   updatedAt       DateTime @updatedAt
// }

// model ActivityFailLog {
//   id              String   @id @default(uuid())
//   api             String
//   userId          String
//   activityId      String
//   accessToken     String

//   status          Int
//   statusText      String
//   rawLog          String

//   createdAt       DateTime @default(now())
//   updatedAt       DateTime @updatedAt
// }

// model QuizBadgeStage {
//   id              String   @id @default(uuid())
//   campaignId      String
//   badgeType       QuizBadgeType
//   quizStageIndex  Int

//   createdAt       DateTime @default(now())
//   updatedAt       DateTime @updatedAt
// }

// enum QuizBadgeType {
//   EXPERT
//   ADVANCED
// }
