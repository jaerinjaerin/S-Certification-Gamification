// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
  output   = env("PRISMA_CLIENT_OUTPUT")
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// generator erd {
//   provider = "prisma-erd-generator"
//   output   = "./erd.svg"
// }

model Account {
  id                String   @id @default(cuid())
  userId            String   @map("user_id")
  type              String
  provider          String
  providerAccountId String   @map("provider_account_id")
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.Text
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  expires      DateTime
  sessionToken String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id])

  @@map("sessions")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?  @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  accounts      Account[]
  sessions      Session[]

  emailId   String?
  
  // profileId String?      @unique
  // profile   UserProfile?
  authType  AuthType?

  providerUserId        String?
  providerPersonId      Int?
  // // jobName             String?
  jobId             String?
  job               Job? @relation(fields: [jobId], references: [id])
  


  sumtotalDomainId              String?
  sumtotalDomainCode              String?
  sumtotalJobId              String?
  sumtotalLanguageId              String?
  // sumtotalOrganizationIds String?
  
  // sumtotalChannelSegmentId           String?
  // sumtotalStoreId           String?
  
  // channelSegmentId            String?
  // salesFormatId  String?
  // channel  String?
  

  domain      Domain? @relation(fields: [domainId], references: [id])
  language    Language? @relation(fields: [languageId], references: [id])




  domainId              String?
  languageId              String?

  regionId String?
  subsidaryId String?
  channelSegmentId String?
  storeId String?
  channelId String?

  // userQuizLogs     UserQuizLog[]
  userQuizLogs UserQuizLog[]
  // userQuizStageLogs     UserQuizStageLog[]
  // userQuizSetLogs     UserQuizSetLog[]
  // userQuestionAttempt UserQuestionAttempt[]

  @@map("users")
}

// model UserProfile {
//   id     String  @id @default(cuid())
//   name   String?
//   image  String?
//   userId String? @unique
//   user   User?   @relation(fields: [userId], references: [id])

//   @@map("user_profiles")
// }

model UserEmail {
  id     String  @id @default(cuid())
  email  String  
  // user      User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String?
}

model VerificationRequest {
  id         String   @id @default(cuid())
  identifier String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, token])
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model VerifyToken {
  id          String   @id @default(cuid()) // 고유 식별자
  email       String   // 인증할 이메일
  token       String   // 인증 토큰 (6개의 숫자 문자열)
  expiresAt   DateTime // 토큰 만료 시간
  createdAt   DateTime @default(now()) // 생성 시간
  updatedAt   DateTime @updatedAt // 마지막 갱신 시간

  @@index([email]) // 이메일 검색을 빠르게 하기 위한 인덱스
  @@index([token]) // 토큰 검색을 빠르게 하기 위한 인덱스
}

enum AuthType {
  SUMTOTAL
  GUEST
}


model Language {
  id         String   @id @default(uuid())
  code       String   @unique // Language code (e.g., en, fr, es)
  name       String   // Language name

  // campaignDomainQuizSets CampaignDomainQuizSet[]
  // questions Question[]
  // questionOption QuestionOption[]
  users User[]
}

// model Countr
model Campaign {
  id          String   @id @default(uuid())
  name        String      // Name of the campaign
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  startedAt   DateTime
  endedAt     DateTime

  createrId   String
  updaterId   String?

  // campaignDomainQuizSets  CampaignDomainQuizSet[]
  quizSets  QuizSet[]
  domainGoals  DomainGoal[]
}

model Hq {
  id         String   @id 
  name       String
  code       String   @unique // Domain name

  regions Region[] 
}

model Region {
  id         String   @id 
  name String
  code       String   @unique // Domain name

  hqId String?
  hq Hq? @relation(fields: [hqId], references: [id])

  subsidaries Subsidary[]

  // domain Domain[]
}

model Subsidary {
  id         String   @id 
  name String
  code       String   @unique // Domain name

  regionId String?
  region Region? @relation(fields: [regionId], references: [id])

  domains Domain[]
  quizSets  QuizSet[]
}

model Domain {
  id         String   @id 
  name       String
  code       String   @unique // Domain name
  // regionId   String
  subsidaryId  String?

  // region   Region @relation(fields: [regionId], references: [id])
  subsidary   Subsidary? @relation(fields: [subsidaryId], references: [id])

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // campaignDomainQuizSets  CampaignDomainQuizSet[]
  quizSets  QuizSet[]
  // channelSegmentIds String
  users User[]
  domainGoals  DomainGoal[]
}

model DomainGoal {
  id         String   @id @default(uuid())
  campaignId String
  domainId   String
  userCount   Int
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  campaign   Campaign    @relation(fields: [campaignId], references: [id])
  domain     Domain      @relation(fields: [domainId], references: [id])
}

model QuizSet {
  id         String   @id @default(uuid())

  // path       String
  // paths       String[]
  campaignId String      // Foreign key to Campaign
  domainId   String?      // Foreign key to Domain
  subsidaryId   String?      // Foreign key to Subsidary
  // jobId             String
  // jobIds             String[]
  jobCodes             String[]
  // languageIds        String[]
  // languageIds        String
  // questionIds       String
  quizStages     QuizStage[]

  // badgeStages    Int[]
  // badgeActivityIds String[]
  // firstBadgeStage    Int?
  // firstBadgeActivityId String?
  // lastBadgeActivityId String?

  createrId   String
  updaterId   String?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  campaign   Campaign    @relation(fields: [campaignId], references: [id])
  domain     Domain?      @relation(fields: [domainId], references: [id])
  subsidary   Subsidary?      @relation(fields: [subsidaryId], references: [id])
  // language     Language      @relation(fields: [languageId], references: [id])

  userQuizLogs UserQuizLog[]
}

model QuizStage {
  id         String   @id @default(uuid())
  name       String     // Name of the stage
  order      Int        // Order of the stage within the quiz set
  // questions  Question[] // Associated questions
  questionIds       String[]
  lifeCount   Int         // Number of lives for the question
  // quizSetId  String        // Foreign key to QuizSet
  // quizSet    QuizSet    @relation(fields: [quizSetId], references: [id])
  // campaignDomainQuizSetId  String        // Foreign key to QuizSet
  // campaignDomainQuizSet    CampaignDomainQuizSet @relation(fields: [campaignDomainQuizSetId], references: [id])

  quizSetId  String
  quizSet  QuizSet @relation(fields: [quizSetId], references: [id])

  // campaign    Campaign    @relation(fields: [campaignId], references: [id])
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  userQuizStageLogs UserQuizStageLog[]
  // userQuizQuestionLogs UserQuizQuestionLog[]


  isBadgeStage Boolean?
  badgeActivityId String?
  badgeImageUrl String?

  backgroundImageUrl String?
  characterImageUrl String?
}

model Question {
  id          String   @id @default(uuid())
  text        String      // Text of the question in default language
  
  timeLimitSeconds   Int         // Expiration time for the question in seconds
  options     QuestionOption[] // Associated options
  // quizStageId     String?         // Foreign key to Stage
  order       Int
  // quizStage       QuizStage       @relation(fields: [quizStageId], references: [id])
  
  languageId  String      // Foreign key to Language
  originalQuestionId    String     // Foreign key to Question
  originalIndex    Int     // Foreign key to Question
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  // language    Language    @relation(fields: [languageId], references: [id])
  // userQuizQuestionLog    UserQuizQuestionLog[] // Logs of user interactions with this question
  backgroundImageUrl String?
  characterImageUrl String?

  category    String
  specificFeature   String
  enabled     Boolean
  product    String
  questionType    QuestionType

  userQuizQuestionLogs UserQuizQuestionLog[]
}

enum QuestionType {
  MULTIPLE_CHOICE
  SINGLE_CHOICE
  TRUE_FALSE
}

model QuestionOption {
  id          String   @id @default(uuid())
  text        String              // Text of the option
  order       Int                 // Order of the option within the question
  // translations QuestionOptionTranslation[]
  questionId  String                 // Foreign key to Question
  question    Question            @relation(fields: [questionId], references: [id])
  languageId   String
  // language    Language            @relation(fields: [languageId], references: [id])
  isCorrect   Boolean             // Whether the option is correct

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model Job {
  id         String   @id
  // groupCode  String
  code        String
  group        String
  name       String   // Name of the user group (e.g., A, B)
  description String? // Optional description
  // countryJobQuestionsUeage QuestionUsage[] // Associated CountryGroup entries
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  users User[]
  // salesFormats SalesFormat[]
}

model Store {
  id         String   @id
  name       String
  // code       String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model ChannelSegment {
  id            String                @id @default(uuid())
  name          String          // e.g., "Carrier", "Retailer (MM/IT/Traditional etc)"
  // salesFormats  SalesFormat[]   // One-to-many relationship with SalesFormat
}

// model SalesFormat {
//   id                String                @id @default(uuid())
//   // channelSegmentId  String             // Foreign key to ChannelSegment
//   // channelSegment    ChannelSegment  @relation(fields: [channelSegmentId], references: [id])
//   storeType         String          // e.g., "Off line Store", "On line Store"
//   // jobId             String          // Replaced 'format' with 'jobCode' (e.g., "FSM(C&R)", "FF", "SES")
//   // job               Job             @relation(fields: [jobId], references: [id])
// }

model UserQuizLog {
  id          String   @id @default(uuid())
  userId      String
  campaignId String
  // quizSetId   String
  
  // activityId String
  // metadataId String
  // firstBadgeStage   Int?
  // isFirstBadgeStageCompleted    Boolean?
  // badgeStages    Int[]
  // badgeActivityIds String[]
  isCompleted    Boolean?
  // badgeAcquisitionDates DateTime[]
  isBadgeAcquired Boolean?
  lastCompletedStage    Int?
  elapsedSeconds    Int?      // Time spent on this activity (in seconds)
  createdAt   DateTime @default(now()) // 히스토리 생성 시간
  updatedAt   DateTime @updatedAt // 히스토리 수정 시간

  user        User    @relation(fields: [userId], references: [id])
  


  // campaignDomainQuizSetId String
  // campaignDomainQuizSet    CampaignDomainQuizSet  @relation(fields: [campaignDomainQuizSetId], references: [id])
  quizSetId String
  quizSet    QuizSet  @relation(fields: [quizSetId], references: [id])
  // campaignActivityId String
  // campaignActivity  CampaignActivity  @relation(fields: [campaignActivityId], references: [id])
  // quizSet QuizSet? @relation(fields: [quizSetId], references: [id])

  // countryCode String

  
  // firstBadgeActivityId String?
  // lastBadgeActivityId String?
  // languageCode String?
  
  score       Int?

  quizSetPath String?


  
  domainId String?
  languageId String?

  jobId       String?

  // @@unique([userId, campaignId, domainId]) // 각 유저는 특정 퀴즈 세트에 대해 하나의 히스토리만 가질 수 있음



  regionId String?
  subsidaryId String?
  channelSegmentId String?
  storeId String?
  channelId String?

  @@unique([userId, campaignId])
}

model UserQuizBadgeStageLog {
  id          String   @id @default(uuid())
  userId      String
  campaignId String
  
  isBadgeAcquired Boolean?
  badgeActivityId String?
  elapsedSeconds    Int?
  createdAt   DateTime @default(now()) // 히스토리 생성 시간
  updatedAt   DateTime @updatedAt // 히스토리 수정 시간

  quizSetId String
  quizStageId String
  quizStageIndex Int
  
  score       Int

  domainId String?
  languageId String?
  jobId       String?
  regionId String?
  subsidaryId String?
  channelSegmentId String?
  storeId String?
  channelId String?

  @@unique([userId, campaignId])
}


model UserQuizStageLog {
  id           String   @id @default(uuid())
  userId       String      // Foreign key to User
  
  // user         User     @relation(fields: [userId], references: [id])

  campaignId  String
  quizStageId      String      // Foreign key to Stage
  quizStage        QuizStage    @relation(fields: [quizStageId], references: [id])
  // isCompleted  Boolean  // Whether the stage was completed
  // timeSpent    Int      // Time spent on this stage (in seconds)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  isBadgeStage Boolean?
  isBadgeAcquired   Boolean?
  badgeActivityId String?

  remainingHearts Int

  // countryCode String
  // campaignDomainId String
  // domainId String
  // campaignDomainQuizSetId String
  quizSetId String
  quizStageIndex Int

  elapsedSeconds Int

  // startedAt DateTime?
  // endedAt DateTime?
  score       Int?
  // languageCode String
  // activityId  String
  // campaignActivityId  String

  domainId String
  languageId String?
  jobId String
  
  regionId String?
  subsidaryId String?
  channelSegmentId String?
  storeId String?
  channelId String?
}

model UserQuizQuestionLog {
  id           String   @id @default(uuid())
  userId       String      // Foreign key to User
  quizSetId   String      // Foreign key to QuizSet
  
  // user result
  questionId   String      // Foreign key to Question
  question     Question? @relation(fields: [questionId], references: [id])
  isCorrect    Boolean  // Whether the user answered the question correctly
  selectedOptionIds String[]
  correctOptionIds String[]
  quizStageId String
  // quizStage        QuizStage    @relation(fields: [quizStageId], references: [id])

  quizStageIndex  Int
  elapsedSeconds Int

  // question
  category    String
  specificFeature   String
  product    String
  questionType    QuestionType

  // country
  campaignId  String
  jobId String
  languageId String?

  domainId String?

  regionId String?
  subsidaryId String?
  channelSegmentId String?
  storeId String?
  channelId String?
  

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
