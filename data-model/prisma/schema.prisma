// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  output        = env("PRISMA_CLIENT_OUTPUT")
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  type              String
  provider          String
  providerAccountId String   @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  expires      DateTime
  sessionToken String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id])

  @@map("sessions")
}

model User {
  id               String     @id @default(uuid())
  name             String?
  loginName        String?
  email            String?    @unique
  emailVerified    DateTime?
  image            String?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  emailId          String?
  authType         AuthType
  providerUserId   String?
  providerPersonId String?
  jobId            String?
  domainId         String?
  domainCode       String?
  languageId       String?
  regionId         String?
  subsidiaryId     String?
  storeId          String?
  storeSegmentText String?
  channelId        String?
  channelSegmentId String?
  channelName      String?
  UserRole         UserRole[]
  accounts         Account[]
  sessions         Session[]

  @@map("users")
}

model VerificationRequest {
  id         String   @id @default(uuid())
  identifier String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, token])
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model VerifyToken {
  id        String   @id @default(uuid())
  email     String
  token     String
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([token])
}

model Language {
  id   String @id @default(uuid())
  code String @unique
  name String
  quizSets QuizSet[]
  domainWebLanguages DomainWebLanguage[]
}

model Campaign {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique @default("s25")
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime
  endedAt     DateTime
  createrId   String
  updaterId   String?
  domainId    String?
  quizSets    QuizSet[]
  settingsId  String?   @unique
  settings    CampaignSettings? @relation(fields: [settingsId], references: [id])
  domainWebLanguages DomainWebLanguage[]
}

model CampaignSettings {
  id                        String   @id @default(uuid())
  campaignId                String
  totalStages               Int?
  firstBadgeName            String?
  secondBadgeName           String?
  ffFirstBadgeStageIndex    Int?
  ffSecondBadgeStageIndex   Int?
  fsmFirstBadgeStageIndex   Int?
  fsmSecondBadgeStageIndex  Int?
  campaign                  Campaign?
}

model Hq {
  id      String   @id
  name    String
  code    String   @unique
  order   Int?
  regions Region[]
}

model Region {
  id           String       @id
  name         String
  code         String       @unique
  order        Int?
  hqId         String?
  hq           Hq?          @relation(fields: [hqId], references: [id])
  subsidiaries Subsidiary[]
}

model Subsidiary {
  id       String   @id
  name     String
  code     String   @unique
  order    Int?
  regionId String?
  domains  Domain[]
  region   Region?  @relation(fields: [regionId], references: [id])
}

model Domain {
  id           String      @id
  name         String
  code         String      @unique
  subsidiaryId String?
  order        Int?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  permissionId String?
  Permission   Permission? @relation(fields: [permissionId], references: [id])
  subsidiary   Subsidiary? @relation(fields: [subsidiaryId], references: [id])

  quizSets      QuizSet[]
  domainWebLanguages DomainWebLanguage[]
}

model DomainGoal {
  id           String   @id @default(uuid())
  campaignId   String
  ff           Int
  fsm          Int
  ffSes        Int
  fsmSes       Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  domainId     String
  regionId     String?
  subsidiaryId String?
}

model QuizSet {
  id           String      @id @default(uuid())
  campaignId   String
  domainId     String?
  domain       Domain?     @relation(fields: [domainId], references: [id])
  languageId   String?
  language     Language?    @relation(fields: [languageId], references: [id])
  subsidiaryId String?
  jobCodes     String[]
  createrId    String
  updaterId    String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  campaign     Campaign    @relation(fields: [campaignId], references: [id])
  quizStages   QuizStage[]
  questions    Question[]
  questionOptions    QuestionOption[]
  quizSetFiles  QuizSetFile[]
}

model QuizSetFile {
  id            String   @id @default(uuid())
  campaignId    String
  domainId      String
  languageId    String
  quizSetId     String
  quizSet       QuizSet  @relation(fields: [quizSetId], references: [id], onDelete: Cascade)
  jobCodes      String[]
  path          String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model QuizBadge {
  id          String      @id @default(uuid())
  name        String?
  description String?
  imagePath   String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  campaignId  String?
  domainId    String?
  quizStages  QuizStage[]
  activityBadges ActivityBadge[]
}

model Image {
  id                   String     @id @default(uuid())
  alt                  String?
  title                String?
  caption              String?
  format               String
  categories           String[]
  imagePath            String
  thumbnailPath        String?
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
  campaignId           String?
  domainId             String?
  questionsBackgrounds Question[] @relation("BackgroundImage")
  questionsCharacters  Question[] @relation("CharacterImage")
}

model QuizStage {
  id              String     @id @default(uuid())
  name            String
  order           Int
  questionIds     String[]
  lifeCount       Int
  quizSetId       String
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  isBadgeStage    Boolean?
  badgeActivityId String?
  badgeImageId    String?
  badgeType       BadgeType?
  campaignId      String?
  domainId        String?
  languageId      String?
  badgeImage      QuizBadge? @relation(fields: [badgeImageId], references: [id])
  quizSet         QuizSet    @relation(fields: [quizSetId], references: [id], onDelete: Cascade)
  questions       Question[]
}

model Question {
  id                 String           @id @default(uuid())
  text               String
  timeLimitSeconds   Int
  order              Int
  languageId         String
  originalQuestionId String
  originalIndex      Int
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  backgroundImageId  String?
  characterImageId   String?
  category           String?
  specificFeature    String?
  importance         String?
  product            String?
  enabled            Boolean
  questionType       QuestionType
  campaignId         String?
  domainId           String?
  backgroundImage    Image?           @relation("BackgroundImage", fields: [backgroundImageId], references: [id])
  characterImage     Image?           @relation("CharacterImage", fields: [characterImageId], references: [id])
  options            QuestionOption[]
  quizStageId        String?
  quizStage          QuizStage?       @relation(fields: [quizStageId], references: [id], onDelete: Cascade)
  quizSetId          String?
  quizSet            QuizSet?         @relation(fields: [quizSetId], references: [id])
}

model QuestionOption {
  id         String   @id @default(uuid())
  text       String
  order      Int
  questionId String
  languageId String
  isCorrect  Boolean
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  domainId   String?
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  campaignId String?
  quizSetId  String?
  quizSet    QuizSet? @relation(fields: [quizSetId], references: [id])
}

model Job {
  id          String   @id
  code        String
  group       String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Store {
  id        String   @id
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Channel {
  id   String @id @default(uuid())
  name String
}

model ChannelSegment {
  id   String @id @default(uuid())
  name String
}

model UserQuizLog {
  id                 String   @id @default(uuid())
  userId             String
  authType           AuthType
  campaignId         String
  isCompleted        Boolean?
  isBadgeAcquired    Boolean?
  lastCompletedStage Int?
  elapsedSeconds     Int?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  quizSetId          String
  score              Int?
  quizSetPath        String?
  domainId           String?
  languageId         String?
  jobId              String?
  regionId           String?
  subsidiaryId       String?
  storeId            String?
  storeSegmentText   String?
  channelId          String?
  channelSegmentId   String?
  channelName        String?

  @@unique([userId, campaignId])
}

model UserQuizBadgeStageLog {
  id               String   @id @default(uuid())
  userId           String
  authType         AuthType
  campaignId       String
  isBadgeAcquired  Boolean?
  badgeActivityId  String?
  elapsedSeconds   Int?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  quizSetId        String
  quizStageId      String
  quizStageIndex   Int
  score            Int
  domainId         String?
  languageId       String?
  jobId            String?
  regionId         String?
  subsidiaryId     String?
  storeId          String?
  storeSegmentText String?
  channelId        String?
  channelSegmentId String?
  channelName      String?
  badgeType        BadgeType?

  @@unique([userId, campaignId, quizStageId])
}

model UserQuizStageLog {
  id               String   @id @default(uuid())
  userId           String
  authType         AuthType
  campaignId       String
  quizStageId      String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  isBadgeStage     Boolean?
  isBadgeAcquired  Boolean?
  badgeActivityId  String?
  remainingHearts  Int
  quizSetId        String
  quizStageIndex   Int
  elapsedSeconds   Int
  score            Int?
  totalScore       Int?
  percentile       Int?
  scoreRange       String?
  domainId         String
  languageId       String?
  jobId            String
  regionId         String?
  subsidiaryId     String?
  storeId          String?
  storeSegmentText String?
  channelId        String?
  channelSegmentId String?
  channelName      String?
  badgeType        BadgeType?
}

model UserQuizQuestionLog {
  id                 String       @id @default(uuid())
  userId             String
  authType           AuthType
  quizSetId          String
  questionId         String
  questionText       String?
  isCorrect          Boolean
  selectedOptionIds  String[]
  correctOptionIds   String[]
  quizStageId        String
  quizStageIndex     Int
  elapsedSeconds     Int
  questionType       QuestionType
  category           String?
  product            String?
  specificFeature    String?
  importance         String?
  campaignId         String
  jobId              String
  languageId         String?
  domainId           String?
  regionId           String?
  subsidiaryId       String?
  storeId            String?
  storeSegmentText   String?
  channelId          String?
  channelSegmentId   String?
  channelName        String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  tryNumber          Int
  originalQuestionId String?
  originalIndex      Int?
}

model UserQuizStatistics {
  id                 String   @id @default(uuid())
  userId             String
  authType           AuthType
  campaignId         String
  isCompleted        Boolean?
  isBadgeAcquired    Boolean?
  lastCompletedStage Int?
  elapsedSeconds     Int?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  quizSetId          String
  score              Int?
  quizSetPath        String?
  domainId           String?
  languageId         String?
  jobId              String?
  regionId           String?
  subsidiaryId       String?
  storeId            String?
  storeSegmentText   String?
  channelId          String?
  channelSegmentId   String?
  channelName        String?
}

model UserQuizBadgeStageStatistics {
  id               String   @id @default(uuid())
  userId           String
  authType         AuthType
  campaignId       String
  isBadgeAcquired  Boolean?
  badgeActivityId  String?
  elapsedSeconds   Int?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  quizSetId        String
  quizStageId      String
  quizStageIndex   Int
  score            Int
  domainId         String?
  languageId       String?
  jobId            String?
  regionId         String?
  subsidiaryId     String?
  storeId          String?
  storeSegmentText String?
  channelId        String?
  channelSegmentId String?
  channelName      String?
  badgeType        BadgeType?

  @@unique([userId, campaignId, quizStageId])
}

model UserQuizStageStatistics {
  id               String   @id @default(uuid())
  userId           String
  authType         AuthType
  campaignId       String
  quizStageId      String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  isBadgeStage     Boolean?
  isBadgeAcquired  Boolean?
  badgeActivityId  String?
  remainingHearts  Int
  quizSetId        String
  quizStageIndex   Int
  elapsedSeconds   Int
  score            Int?
  totalScore       Int?
  percentile       Int?
  scoreRange       String?
  domainId         String
  languageId       String?
  jobId            String
  regionId         String?
  subsidiaryId     String?
  storeId          String?
  storeSegmentText String?
  channelId        String?
  channelSegmentId String?
  channelName      String?
  badgeType        BadgeType?
}

model UserQuizQuestionStatistics {
  id                 String       @id @default(uuid())
  userId             String
  authType           AuthType
  quizSetId          String
  questionId         String
  questionText       String?
  isCorrect          Boolean
  selectedOptionIds  String[]
  correctOptionIds   String[]
  quizStageId        String
  quizStageIndex     Int
  elapsedSeconds     Int
  tryNumber          Int
  questionType       QuestionType
  category           String?
  product            String?
  specificFeature    String?
  importance         String?
  campaignId         String
  jobId              String
  languageId         String?
  domainId           String?
  regionId           String?
  subsidiaryId       String?
  storeId            String?
  storeSegmentText   String?
  channelId          String?
  channelSegmentId   String?
  channelName        String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  originalQuestionId String?
  originalIndex      Int?
}

model Role {
  id              String            @id @default(uuid())
  name            String            @unique
  description     String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  permissions     RolePermission[]
  users           UserRole[]
  UserRoleMapping UserRoleMapping[]
}

model Permission {
  id          String           @id @default(uuid())
  name        String           @unique
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  domains     Domain[]
  roles       RolePermission[]
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  permissionId String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @default(now())
  permission   Permission @relation(fields: [permissionId], references: [id])
  role         Role       @relation(fields: [roleId], references: [id])

  @@unique([roleId, permissionId], name: "role_permission_unique")
  @@index([roleId])
  @@index([permissionId])
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  role      Role     @relation(fields: [roleId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId], name: "user_role_unique")
  @@index([userId])
  @@index([roleId])
}

model UserRoleMapping {
  id        String   @id @default(uuid())
  loginName String   @unique
  roleId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  role      Role     @relation(fields: [roleId], references: [id])

  @@index([roleId])
}

enum AuthType {
  SUMTOTAL
  GUEST
  UNKNOWN
}

enum QuestionType {
  MULTI_CHOICE
  SINGLE_CHOICE
  TRUE_FALSE
}

model ActivityBadge {
  id              String   @id @default(uuid())
  activityId      String

  campaignId      String
  // jobCodes        String[]
  jobCode         String
  badgeType       BadgeType
  domainId        String
  languageId      String

  badgeImageId    String?
  badgeImage      QuizBadge? @relation(fields: [badgeImageId], references: [id]) 

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model UploadedFile {
  id            String   @id @default(uuid())
  campaignId    String
  domainId      String?
  languageId    String?
  originId      String?
  jobCode       String?
  uploadedBy    String
  path          String
  fileType      FileType
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

enum FileType {
  QUIZSET
  ACTIVITYID
  TARGET
  UI_LANGUAGE
  NON_SPLUS_DOMAINS
}
model BadgeLog {
  id              String   @id @default(uuid())
  apiType         BadgeApiType
  status          Int
  message         String
  
  userId          String?
  accountUserId   String?

  activityId      String
  accessToken     String?

  rawLog          String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  campaignId      String?
  domainId        String?
}

// model BadgeStage {
//   id              String   @id @default(uuid())
//   campaignId      String
//   jobCode         String
//   badgeType       BadgeType
//   quizStageIndex  Int
//   name            String
  
//   createdAt       DateTime @default(now())
//   updatedAt       DateTime @updatedAt
// }

// enum BadgeType {
//   EXPERT
//   ADVANCED
// }

enum BadgeApiType {
  REGISTER
  PROGRESS
}

enum BadgeType {
  FIRST
  SECOND
}

model DomainWebLanguage {
  id              String   @id @default(uuid())
  campaignId      String?
  campaign        Campaign? @relation(fields: [campaignId], references: [id])
  domainId        String
  domain          Domain @relation(fields: [domainId], references: [id])
  languageId      String
  language        Language @relation(fields: [languageId], references: [id])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}