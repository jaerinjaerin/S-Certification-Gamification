# apps/client/Dockerfile
# syntax=docker/dockerfile:1

#
# 1) Build Stage
#
FROM node:20-alpine AS builder

# Build arguments (ARG)
ARG ENV
ARG DATABASE_URL
ARG AUTH_URL
ARG NEXTAUTH_URL
ARG AUTH_SECRET
ARG NEXTAUTH_SECRET
ARG SUMTOTAL_CLIENT_ID
ARG SUMTOTAL_CLIENT_SECRET
ARG SUMTOTAL_CALLBACK_URL
ARG NEXT_PUBLIC_AUTH_SUMTOTAL_SIGNOUT
ARG NEXT_PUBLIC_API_URL
ARG NEXT_PUBLIC_ASSETS_DOMAIN
ARG NEXT_PUBLIC_BASE_PATH
ARG AWS_SES_REGION
ARG AWS_SES_SENDER
ARG ENCRYPT_SECRET_KEY
ARG PRISMA_CLIENT_OUTPUT
ARG NEXT_PUBLIC_GA_ID
ARG DISCORD_WEBHOOK_URL
ARG NEXT_PUBLIC_ENV

# Set environment variables (ENV)
ENV ENV=${ENV}
ENV DATABASE_URL=${DATABASE_URL}
ENV AUTH_URL=${AUTH_URL}
ENV NEXTAUTH_URL=${NEXTAUTH_URL}
ENV AUTH_SECRET=${AUTH_SECRET}
ENV NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
ENV SUMTOTAL_CLIENT_ID=${SUMTOTAL_CLIENT_ID}
ENV SUMTOTAL_CLIENT_SECRET=${SUMTOTAL_CLIENT_SECRET}
ENV SUMTOTAL_CALLBACK_URL=${SUMTOTAL_CALLBACK_URL}
ENV NEXT_PUBLIC_AUTH_SUMTOTAL_SIGNOUT=${NEXT_PUBLIC_AUTH_SUMTOTAL_SIGNOUT}
ENV NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
ENV NEXT_PUBLIC_ASSETS_DOMAIN=${NEXT_PUBLIC_ASSETS_DOMAIN}
ENV NEXT_PUBLIC_BASE_PATH=${NEXT_PUBLIC_BASE_PATH}
ENV AWS_SES_REGION=${AWS_SES_REGION}
ENV AWS_SES_SENDER=${AWS_SES_SENDER}
ENV ENCRYPT_SECRET_KEY=${ENCRYPT_SECRET_KEY}
ENV PRISMA_CLIENT_OUTPUT=${PRISMA_CLIENT_OUTPUT}
ENV NEXT_PUBLIC_GA_ID=${NEXT_PUBLIC_GA_ID}
ENV DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
ENV NEXT_PUBLIC_ENV=${NEXT_PUBLIC_ENV}

WORKDIR /app

# 1-1. 루트에 있는 pnpm 관련 파일 복사
COPY package.json package-lock.json ./

RUN npm install

# 1-2. 참조 파일 복사
COPY data-model/prisma/schema.prisma data-model/prisma/
# COPY upload_seed_data/data/seeds/languages.json upload_seed_data/data/seeds/

# 1-3. 소스 코드 복사
COPY client/ client/

# 1-4. workspace 전체 설치
WORKDIR /app/client
RUN npm install

# 1-5. client 앱 빌드
RUN npm run prisma:generate
RUN npm run build:stg

#
# 2) Run Stage
#
FROM node:20-alpine AS runner

# Build arguments (ARG)
ARG ENV
ARG DATABASE_URL
ARG AUTH_URL
ARG NEXTAUTH_URL
ARG AUTH_SECRET
ARG NEXTAUTH_SECRET
ARG SUMTOTAL_CLIENT_ID
ARG SUMTOTAL_CLIENT_SECRET
ARG SUMTOTAL_CALLBACK_URL
ARG NEXT_PUBLIC_AUTH_SUMTOTAL_SIGNOUT
ARG NEXT_PUBLIC_API_URL
ARG NEXT_PUBLIC_ASSETS_DOMAIN
ARG NEXT_PUBLIC_BASE_PATH
ARG AWS_SES_REGION
ARG AWS_SES_SENDER
ARG ENCRYPT_SECRET_KEY
ARG PRISMA_CLIENT_OUTPUT
ARG NEXT_PUBLIC_GA_ID
ARG DISCORD_WEBHOOK_URL
ARG NEXT_PUBLIC_ENV

# Set environment variables (ENV)
ENV ENV=${ENV}
ENV DATABASE_URL=${DATABASE_URL}
ENV AUTH_URL=${AUTH_URL}
ENV NEXTAUTH_URL=${NEXTAUTH_URL}
ENV AUTH_SECRET=${AUTH_SECRET}
ENV NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
ENV SUMTOTAL_CLIENT_ID=${SUMTOTAL_CLIENT_ID}
ENV SUMTOTAL_CLIENT_SECRET=${SUMTOTAL_CLIENT_SECRET}
ENV SUMTOTAL_CALLBACK_URL=${SUMTOTAL_CALLBACK_URL}
ENV NEXT_PUBLIC_AUTH_SUMTOTAL_SIGNOUT=${NEXT_PUBLIC_AUTH_SUMTOTAL_SIGNOUT}
ENV NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
ENV NEXT_PUBLIC_ASSETS_DOMAIN=${NEXT_PUBLIC_ASSETS_DOMAIN}
ENV NEXT_PUBLIC_BASE_PATH=${NEXT_PUBLIC_BASE_PATH}
ENV AWS_SES_REGION=${AWS_SES_REGION}
ENV AWS_SES_SENDER=${AWS_SES_SENDER}
ENV ENCRYPT_SECRET_KEY=${ENCRYPT_SECRET_KEY}
ENV PRISMA_CLIENT_OUTPUT=${PRISMA_CLIENT_OUTPUT}
ENV NEXT_PUBLIC_GA_ID=${NEXT_PUBLIC_GA_ID}
ENV DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
ENV NEXT_PUBLIC_ENV=${NEXT_PUBLIC_ENV}

WORKDIR /app

# 전역 pm2 설치
RUN npm install -g pm2

# 빌드 산출물 복사
COPY --from=builder /app ./

WORKDIR /app/client

# Next.js 서버 포트
EXPOSE 3000

# admin 앱 실행
CMD ["npm", "run", "start:pm2"]
